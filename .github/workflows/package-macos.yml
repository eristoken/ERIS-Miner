name: Package macOS

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        type: string
        default: ''
      build_run_id:
        description: 'Build workflow run ID (optional - to use build artifacts)'
        required: false
        type: string
        default: ''

jobs:
  package-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Download build artifacts
        id: download-artifacts
        if: inputs.build_run_id != ''
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.build_run_id }}
          path: .
      
      - name: Check if artifacts downloaded
        id: check-artifacts
        run: |
          if [ -d "dist" ] && [ -d "dist-electron" ]; then
            echo "artifacts_found=true" >> $GITHUB_OUTPUT
          else
            echo "artifacts_found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Install dependencies
        if: steps.check-artifacts.outputs.artifacts_found != 'true'
        run: npm ci
      
      - name: Build application
        if: steps.check-artifacts.outputs.artifacts_found != 'true'
        run: npm run build
      
      - name: Import Apple Certificate
        if: env.APPLE_CERTIFICATE != ''
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "$APPLE_CERTIFICATE_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$APPLE_CERTIFICATE_PASSWORD" build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$APPLE_CERTIFICATE_PASSWORD" build.keychain
          rm certificate.p12
      
      - name: Package for macOS
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: npm run make:mac
      
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: eris-miner-macos-dmg-${{ inputs.version || github.sha }}
          path: out/make/*.dmg
          retention-days: 30
      
      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: eris-miner-macos-zip-${{ inputs.version || github.sha }}
          path: out/make/*.zip
          retention-days: 30

